# Расширенная обработка Excel файлов

## Проблема

Заказчики предоставляют Excel файлы со сложной структурой:
- Заголовки колонок не всегда в первой строке
- Встроенные изображения товаров в Excel
- Сложная структура с метаданными
- Объединенные ячейки и пустые строки

## Решение

### 1. Автоматическое определение структуры файла

Новый класс `AdvancedExcelProcessor` автоматически:
- Определяет строку с заголовками колонок
- Анализирует структуру данных
- Извлекает встроенные изображения
- Очищает данные от лишних строк и колонок

### 2. Извлечение встроенных изображений

Система автоматически извлекает изображения из Excel и переименовывает их по part_number:

```python
def extract_embedded_images(self, excel_file_path: str) -> Dict[str, Dict[str, Any]]:
    """
    Извлекает встроенные изображения из Excel файла с информацией о позиции
    Возвращает словарь {имя_изображения: {data: bytes, row: int, col: int}}
    """

def rename_images_by_part_number(self, images, dataframe, header_row, row_images):
    """
    Переименовывает изображения по part_number из соответствующих строк данных
    Пример: excel_image_1.png -> 8053672223453.jpg
    """
```

**Алгоритм работы:**
1. Извлекает все встроенные изображения из Excel
2. Определяет позицию каждого изображения (строка, колонка)
3. Связывает изображения с соответствующими строками данных
4. Находит колонку с part_number (артикулом)
5. Переименовывает изображения по значению part_number
6. Загружает в S3 с корректными именами
7. Привязывает URL изображений к записям в БД

**Поддерживаемые форматы:**
- PNG, JPG, JPEG, GIF
- Автоматическое определение формата
- Сохранение оригинального качества

### 3. Улучшенный маппинг колонок

- Автоматическое предложение маппинга на основе анализа названий
- Комбинирование ИИ-анализа с правилами
- Показ структурной информации и примеров данных

### 4. Визуализация на фронтенде

ColumnMapper теперь показывает:
- Информацию о структуре файла
- Извлеченные изображения
- Предварительный просмотр данных
- Статистику по заголовкам

## Использование

### Backend API

```python
# Новый эндпоинт для загрузки Excel
@router.post("/excel", response_model=UploadResponse)
async def upload_excel(file: UploadFile = File(...)):
    result = advanced_excel_processor.process_excel_advanced(content, file.filename)
    return UploadResponse(
        columns=result['available_columns'],
        mapping=final_mapping,
        structure_info=result['structure_info'],
        sample_data=result['sample_data'],
        extracted_images=encoded_images
    )
```

### Frontend Component

```vue
<ColumnMapper
  :columns="excelData.columns"
  :initial-mapping="excelData.mapping"
  :sample-data="excelData.sample_data"
  :structure-info="excelData.structure_info"
  :extracted-images="excelData.extracted_images"
/>
```

## Технические детали

### Определение заголовков

Система анализирует до 10 первых строк и выбирает строку с наибольшим количеством ключевых слов.

### Извлечение изображений

Использует `openpyxl` для извлечения встроенных изображений:
- Автоматическое определение формата
- Кодирование в base64 для передачи на фронтенд
- Загрузка в S3 при импорте данных

### Очистка данных

- Удаление пустых строк и колонок
- Нормализация названий колонок
- Фильтрация служебной информации

## Пример обработки

Для файла "Kering Eyewear":
1. Система определит что заголовки в строке 4
2. Извлечет изображения товаров из колонки A
3. Предложит маппинг для колонок: UPC Code → part_number, Style name → part_name, и т.д.
4. Покажет превью данных и структурную информацию

## Планы развития

1. **Поддержка объединенных ячеек** - обработка merged cells
2. **OCR для изображений** - извлечение текста с картинок
3. **Автоматическая категоризация** - ИИ анализ для определения категорий
4. **Валидация изображений** - проверка качества и соответствия
5. **Пакетная обработка** - загрузка нескольких файлов одновременно
