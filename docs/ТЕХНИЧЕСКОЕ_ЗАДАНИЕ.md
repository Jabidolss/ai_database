# Техническое задание: AI-платформа для управления базой данных очков

## 1. Общее описание проекта

Разработка веб-платформы на базе искусственного интеллекта для управления базой данных очков с использованием PostgreSQL, Python (backend), S3 для хранения изображений и OpenAI API для обработки естественного языка и маппинга данных.

Платформа предоставляет интерфейс в браузере для загрузки, обработки и управления данными очков через ИИ, включая автоматическое маппинг колонок Excel-файлов, привязку изображений и работу с данными через чат на естественном языке.

**Примечание**: Платформой будет пользоваться один человек - заказчик. Это позволяет упростить систему аутентификации и ролевой модели доступа.

**Специализация**: Платформа предназначена исключительно для управления очками. Категории в системе представляют бренды очков (Gucci, Ray-Ban, Prada и т.д.).

## 2. Цели и задачи

- Автоматизация загрузки и обработки Excel-файлов с данными очков.
- Интеллектуальное маппинг колонок с помощью ИИ с учетом специфики очков.
- Управление изображениями очков с хранением в S3.
- Предоставление интерфейса для редактирования данных очков и генерации отчетов.
- Реализация чата для запросов на естественном языке с переводом в SQL для поиска очков.

## 3. Архитектура системы

### 3.1. Компоненты системы
- **Frontend**: Веб-интерфейс на Vue.js с двумя режимами: "Чат" и "Работа с файлами".
- **Backend**: Python-приложение (FastAPI) для обработки запросов, взаимодействия с БД и ИИ.
- **База данных**: PostgreSQL для хранения данных товаров.
- **Хранение изображений**: Amazon S3 для фото товаров.
- **ИИ-сервис**: Интеграция с OpenAI API для маппинга колонок и NL-to-SQL.

### 3.2. Структура проекта
```
ai_eugen_database/
├── backend/
│   ├── app.py (основное приложение)
│   ├── models.py (модели БД)
│   ├── routes/
│   │   ├── api.py (API эндпоинты)
│   │   ├── chat.py (обработка чата)
│   │   └── files.py (загрузка файлов)
│   ├── services/
│   │   ├── ai_service.py (интеграция с OpenAI)
│   │   ├── excel_processor.py (обработка Excel)
│   │   └── s3_service.py (работа с S3)
│   ├── utils/
│   │   └── sql_generator.py (генерация SQL из NL)
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── ChatInterface.js
│   │   │   ├── FileUpload.js
│   │   │   ├── DataEditor.js
│   │   │   └── ColumnMapper.js
│   │   ├── pages/
│   │   │   ├── ChatPage.js
│   │   │   └── FilesPage.js
│   │   ├── services/
│   │   │   └── apiService.js
│   │   └── App.js
│   ├── public/
│   └── package.json
├── database/
│   ├── migrations/
│   │   └── 001_initial.sql
│   └── schema.sql
├── docs/
│   └── ТЕХНИЧЕСКОЕ_ЗАДАНИЕ.md
└── README.md
```

## 4. База данных

### 4.1. Схема таблицы товаров
Таблица `products` в PostgreSQL с колонками:
- id (PRIMARY KEY, SERIAL)
- images (TEXT, ссылка на S3)
- manufacturer_name (VARCHAR)
- part_number (VARCHAR)
- part_name (VARCHAR)
- category (VARCHAR)
- type (VARCHAR)
- size (VARCHAR)
- color (VARCHAR)
- brand (VARCHAR)
- producer (VARCHAR)
- gender (VARCHAR)
- width (NUMERIC)
- height (NUMERIC)
- age (VARCHAR)
- shape (VARCHAR)
- year (INTEGER)

### 4.2. Миграции
Файлы миграций для создания и обновления схемы БД.

## 5. Backend (Python)

### 5.1. Основные модули
- **app.py**: Инициализация приложения, настройка маршрутов.
- **models.py**: Определение моделей SQLAlchemy для работы с БД.
- **routes/api.py**: REST API для CRUD операций с товарами.
- **routes/chat.py**: Обработка запросов чата, интеграция с ИИ.
- **routes/files.py**: Загрузка и обработка Excel-файлов и изображений.
- **services/ai_service.py**: Взаимодействие с OpenAI API для маппинга и NL-to-SQL.
- **services/excel_processor.py**: Парсинг Excel, маппинг колонок.
- **services/s3_service.py**: Загрузка и управление изображениями в S3.
- **utils/sql_generator.py**: Генерация безопасного SQL из естественного языка.

### 5.2. Функциональность
- Обработка загрузки Excel: Автоматический маппинг колонок с помощью ИИ, отбрасывание неподходящих, вставка данных.
- Управление изображениями: Загрузка архивов, привязка по названию файла к колонке images, предупреждения при несоответствиях.
- Чат: Перевод запросов на естественном языке в SQL, выполнение запросов, возврат результатов.
- Выгрузка данных: Генерация Excel/PDF с фильтрами по колонкам и брендам.

## 6. Frontend (Vue.js)

### 6.1. Технологии и инструменты
- **Фреймворк**: Vue.js 3 для реактивного интерфейса.
- **UI-фреймворк**: PrimeVue V4 для красивого и функционального дизайна с готовыми компонентами.
- **Инструменты**: Vue CLI для создания проекта, Axios для API-запросов, Vue Router для навигации.
- **Почему этот стек**: Простота разработки, низкий порог входа, готовые компоненты для чата, таблиц и форм, responsive дизайн "из коробки".

### 6.2. Основные компоненты
- **ChatInterface.vue**: Интерфейс чата для запросов на естественном языке (использует v-card, v-text-field).
- **FileUpload.vue**: Загрузка Excel и изображений (v-file-input с drag-and-drop).
- **DataEditor.vue**: Редактирование данных товаров в таблице (v-data-table с фильтрами).
- **ColumnMapper.vue**: Ручная корректировка маппинга колонок после ИИ-обработки (v-select, v-checkbox, drag-and-drop для перетаскивания колонок, таблица соответствий с возможностью изменения порядка).

### 6.3. Страницы
- **ChatPage.vue**: Режим чата для поиска, редактирования и генерации отчетов.
- **FilesPage.vue**: Режим работы с файлами для загрузки и обработки данных.

### 6.4. Функциональность
- Полностью русский интерфейс.
- Переключение между режимами "Чат" и "Файлы".
- Отображение результатов запросов в виде таблиц.
- Генерация и скачивание отчетов (Excel, PDF).
- Интеграция с backend через REST API.

## 7. ИИ-компоненты

### 7.1. OpenAI API
- Маппинг колонок Excel к схеме БД (не всегда 100% точен, требует проверки пользователем).
- Перевод естественного языка в SQL-запросы (возможны ошибки в сложных запросах, с корректировкой через интерфейс).
- Проверка и дополнение данных.

### 7.2. Безопасность
- Санитизация SQL-запросов для предотвращения инъекций.
- Валидация входных данных.

## 8. Функциональные требования

### 8.1. Загрузка данных
- Загрузка Excel-файлов с автоматическим маппингом колонок.
- Ручная корректировка маппинга в интерфейсе: Пользователь может перетаскивать колонки, менять их местами или убирать, если ИИ ошибся (например, файл с 30 колонками маппится к 16 в БД).
- Загрузка изображений архивом с привязкой по названию файла.
- Предупреждения при несоответствиях (отсутствующие фото, лишние колонки).
- Зависимость от ИИ: Маппинг не всегда 100% точен, поэтому предусмотрена обязательная проверка и корректировка пользователем перед вставкой данных.

### 8.2. Управление данными
- Полное редактирование данных в интерфейсе.
- Поиск и фильтрация по брендам, категориям и т.д.
- Выгрузка данных в Excel с выбором колонок и фильтров (@ для фильтров на сайте).
  - При выгрузке пользователь должен выбирать, какие колонки включить в файл.
  - Для каждой выбранной колонки указывать, является ли она фильтром: без @ (будет фильтром на сайте) или с @ (не будет фильтром).
  - Интерфейс должен предоставлять чекбоксы для колонок и опции для фильтров.

### 8.3. Чат
- Запросы на естественном языке: поиск, редактирование, удаление, генерация отчетов, создание и обновление товаров (CRUD через NL-to-SQL).
- Примеры: "Найди все очки черного цвета", "Добавь новый товар с брендом X", "Измени размер товара ID 123", "Удали товары старше 5 лет", "Сделай Excel с моделями за август".

## 9. Нефункциональные требования

- **Производительность**: Обработка больших Excel-файлов (до 10k строк) за разумное время.
- **Безопасность**: Базовая защита от SQL-инъекций, простая аутентификация для единственного пользователя.
- **Масштабируемость**: Поддержка роста объема данных.
- **Локализация**: Полностью русский интерфейс.

## 10. План разработки

1. Настройка проекта и БД.
2. Разработка backend: модели, API, сервисы.
3. Интеграция ИИ (OpenAI).
4. Разработка frontend: компоненты, страницы.
5. Тестирование и развертывание.

## 11. Требования к разработке

- Использовать Python 3.9+, PostgreSQL 13+, Vue.js 3+ с PrimeVue V4. 
- Документация кода и API.
- Модульное тестирование ключевых функций.

## 12. Детализация API эндпоинтов (Backend)

### 12.1. Эндпоинты для работы с товарами
Поскольку основное взаимодействие с данными осуществляется через чат на естественном языке (NL-to-SQL), прямые CRUD-эндпоинты для товаров опциональны и предназначены для будущих расширений или вспомогательных задач (например, интеграция с другими системами или детальное отображение в интерфейсе). В конечной версии MVP их можно не реализовывать, фокусируясь на чате. Они оставлены на случай, если потребуется добавить прямой доступ к API для специфических нужд.

- `GET /api/products`: Получение списка товаров с фильтрами (brand, category, etc.) — опционально, для отображения в интерфейсе.
- `POST /api/products`: Создание нового товара — рекомендуется выполнять через чат ("Добавь новый товар с названием X").
- `PUT /api/products/{id}`: Обновление товара по ID — рекомендуется выполнять через чат ("Измени цвет товара ID 123 на синий").
- `DELETE /api/products/{id}`: Удаление товара по ID — рекомендуется выполнять через чат ("Удали товар с ID 123").
- `GET /api/products/{id}`: Получение деталей товара — опционально, для детального просмотра.

### 12.2. Эндпоинты для загрузки файлов
- `POST /api/upload/excel`: Загрузка Excel-файла, возврат предложенного маппинга.
- `POST /api/upload/images`: Загрузка архива с изображениями, привязка к товарам.
- `POST /api/confirm-mapping`: Подтверждение маппинга и вставка данных в БД.

### 12.3. Эндпоинты для чата
- `POST /api/chat/query`: Отправка запроса на естественном языке, возврат SQL и результатов.
- `POST /api/chat/generate-report`: Генерация отчета по запросу, возврат ссылки на файл.

### 12.4. Аутентификация
Поскольку платформой пользуется один пользователь (заказчик), аутентификация упрощена: базовая проверка пароля при входе без ролевой модели. Эндпоинты для входа/выхода опциональны и могут быть реализованы как простая сессия.

## 13. Процессы и workflows

### 13.1. Workflow загрузки Excel
1. Пользователь загружает Excel-файл через интерфейс.
2. Backend парсит файл с помощью Pandas.
3. ИИ анализирует колонки и предлагает маппинг к схеме БД (например, 30 колонок файла к 16 в БД).
4. Frontend отображает предложенный маппинг в удобном интерфейсе: таблица с колонками файла и БД, возможность перетаскивания для изменения соответствий, чекбоксы для исключения колонок.
5. Пользователь корректирует маппинг (меняет местами, убирает лишние), если ИИ ошибся.
6. После подтверждения данные вставляются в БД с валидацией.
7. При несоответствиях выводятся предупреждения (например, "Колонка 'Цвет' не маппится — проверьте").

### 13.2. Workflow загрузки изображений
1. Пользователь загружает ZIP-архив с фото.
2. Backend распаковывает архив и проверяет названия файлов.
3. Сопоставляет с колонкой images в товарах.
4. Загружает фото в S3, обновляет ссылки в БД.
5. Выводит отчет о загруженных/пропущенных файлах.

### 13.3. Workflow чата
1. Пользователь вводит запрос на естественном языке.
2. ИИ переводит запрос в SQL с учетом схемы БД.
3. Выполняется запрос, результаты возвращаются.
4. Для генерации отчетов: 
   - Пользователь выбирает колонки для выгрузки.
   - Указывает фильтры (@ или без для каждой колонки).
   - Создается файл, ссылка отправляется пользователю.

## 14. Пользовательские сценарии

### 14.1. Сценарий 1: Загрузка данных
- Пользователь: Заказчик (единственный пользователь).
- Действия: Загружает Excel с новыми товарами, корректирует маппинг, подтверждает.
- Результат: Данные добавлены в БД, фото привязаны.

### 14.2. Сценарий 2: Поиск через чат
- Пользователь: Заказчик.
- Действия: Вводит "Найди все товары бренда X синего цвета".
- Результат: Таблица с результатами, возможность экспорта.

### 14.3. Сценарий 3: Генерация отчета
- Пользователь: Заказчик.
- Действия: Запрашивает "Сделай Excel с товарами за последний месяц".
- Результат: Скачиваемый файл с выбранными колонками.

## 15. Безопасность и валидация

### 15.1. Меры безопасности
- Шифрование данных в транзите (HTTPS).
- Простая аутентификация для единственного пользователя (пароль).
- Логирование всех операций с данными.
- Регулярные обновления зависимостей для устранения уязвимостей.

### 15.2. Валидация данных
- Проверка типов данных при загрузке (числа, строки).
- Ограничение размера файлов (Excel до 50MB, изображения до 10MB каждое).
- Санитизация входных данных для предотвращения XSS и SQL-инъекций.
- Обязательная пользовательская проверка ИИ-маппинга перед вставкой данных в БД.